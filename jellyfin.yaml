apiVersion: v1
kind: Pod
metadata:
  annotations:
    io.containers.autoupdate/backend: registry
    io.containers.autoupdate/backup-config: registry
    io.containers.autoupdate/backup-media: registry
    io.containers.autoupdate/backup-redundant-config: registry
    io.containers.autoupdate/backup-redundant-media: registry
  labels:
    app: jellyfin
  name: jellyfin
spec:
  containers:
  - name: backend
    image: docker.io/jellyfin/jellyfin:latest
    ports:
    - containerPort: 8096
      hostPort: 8096
    volumeMounts:
    - mountPath: /config
      name: jellyfin-config
    - mountPath: /cache
      name: jellyfin-cache
    - mountPath: /media
      name: jellyfin-media
  - name: backup-config
    image: localhost/restainer:latest
    env:
      - name: RESTIC_TAG
        value: jellyfin-config
      - name: RESTIC_FORGET_ARGS
        value: --keep-daily 28 --keep-weekly 12 --keep-monthly 12 --group-by paths --prune
      - name: RESTIC_PASSWORD
        valueFrom:
          secretKeyRef:
            name: jellyfin
            key: restic_pw
      - name: TERM
        value: xterm
      - name: BACKUP_CRON
        value: "0 5 * * *"
      - name: CHECK_CRON
        value: "0 22 * * *"
    args:
      - tail
      - -fn0
      - /var/log/cron.log
    volumeMounts:
      - mountPath: /mnt/repo
        name: jellyfin-backup-repo-config
      - mountPath: /data
        name: jellyfin-backup-config
      - mountPath: /etc/timezone
        name: etc-timezone
      - mountPath: /etc/localtime
        name: etc-localtime
  - name: backup-media
    image: localhost/restainer:latest
    env:
      - name: RESTIC_TAG
        value: jellyfin-media
      - name: RESTIC_FORGET_ARGS
        value: --keep-daily 28 --keep-weekly 12 --keep-monthly 12 --group-by paths --prune
      - name: RESTIC_PASSWORD
        valueFrom:
          secretKeyRef:
            name: jellyfin
            key: restic_pw
      - name: TERM
        value: xterm
      - name: BACKUP_CRON
        value: "0 5 * * *"
      - name: CHECK_CRON
        value: "0 22 * * *"
    args:
      - tail
      - -fn0
      - /var/log/cron.log
    volumeMounts:
      - mountPath: /mnt/repo
        name: jellyfin-backup-repo-media
      - mountPath: /data
        name: jellyfin-media
      - mountPath: /etc/timezone
        name: etc-timezone
      - mountPath: /etc/localtime
        name: etc-localtime
  - name: backup-redundant-config
    image: localhost/restainer:latest
    env:
      - name: RESTIC_TAG
        value: jellyfin-config
      - name: RESTIC_FORGET_ARGS
        value: --keep-daily 28 --keep-weekly 12 --keep-monthly 12 --group-by paths --prune
      - name: RESTIC_PASSWORD
        valueFrom:
          secretKeyRef:
            name: jellyfin
            key: restic_pw
      - name: TERM
        value: xterm
      - name: BACKUP_CRON
        value: "0 5 * * *"
      - name: CHECK_CRON
        value: "0 22 * * *"
    args:
      - tail
      - -fn0
      - /var/log/cron.log
    volumeMounts:
      - mountPath: /mnt/repo
        name: jellyfin-backup-redundant-repo-config
      - mountPath: /data
        name: jellyfin-backup-config
      - mountPath: /etc/timezone
        name: etc-timezone
      - mountPath: /etc/localtime
        name: etc-localtime
  - name: backup-redundant-media
    image: localhost/restainer:latest
    env:
      - name: RESTIC_TAG
        value: jellyfin-media
      - name: RESTIC_FORGET_ARGS
        value: --keep-daily 28 --keep-weekly 12 --keep-monthly 12 --group-by paths --prune
      - name: RESTIC_PASSWORD
        valueFrom:
          secretKeyRef:
            name: jellyfin
            key: restic_pw
      - name: TERM
        value: xterm
      - name: BACKUP_CRON
        value: "0 5 * * *"
      - name: CHECK_CRON
        value: "0 22 * * *"
    args:
      - tail
      - -fn0
      - /var/log/cron.log
    volumeMounts:
      - mountPath: /mnt/repo
        name: jellyfin-backup-redundant-repo-media
      - mountPath: /data
        name: jellyfin-media
      - mountPath: /etc/timezone
        name: etc-timezone
      - mountPath: /etc/localtime
        name: etc-localtime
  volumes:
  - hostPath:
      path: /etc/timezone
      type: Directory
    name: etc-timezone
  - hostPath:
      path: /etc/localtime
      type: Directory
    name: etc-localtime
  - hostPath:
      path: /opt/pods/jellyfin/config
      type: Directory
    name: jellyfin-config
  - hostPath:
      path: /opt/pods/jellyfin/cache
      type: Directory
    name: jellyfin-cache
  - hostPath:
      path: /mnt/clouddrive/jellyfin
      type: Directory
    name: jellyfin-media
  - hostPath:
      path: /opt/pods/jellyfin
      type: Directory
    name: jellyfin-backup-config
  - hostPath:
      path: /mnt/clouddrive_backup/backup/jellyfin/opt
      type: Directory
    name: jellyfin-backup-repo-config
  - hostPath:
      path: /mnt/clouddrive_backup/backup/jellyfin/media
      type: Directory
    name: jellyfin-backup-repo-media
  - hostPath:
      path: /mnt/clouddrive_backup/backup_redundant/jellyfin/opt
      type: Directory
    name: jellyfin-backup-redundant-repo-config
  - hostPath:
      path: /mnt/clouddrive_backup/backup_redundant/jellyfin/media
      type: Directory
    name: jellyfin-backup-redundant-repo-media
